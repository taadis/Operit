# Operit ç ”å‘æŠ€æœ¯æ–‡æ¡£

## ğŸ“‘ é¡¹ç›®æ¦‚è§ˆ

Operit æ˜¯ä¸€ä¸ªåŸºäº Android å¹³å°çš„é«˜æ€§èƒ½ AI Agentï¼Œé€šè¿‡ LLM é©±åŠ¨çš„çµæ´»å·¥å…·ç³»ç»Ÿå®ç°å¤æ‚äº¤äº’æ™ºèƒ½ã€‚æœ¬æ–‡æ¡£é¢å‘å†…éƒ¨ç ”å‘å›¢é˜Ÿï¼Œæä¾›æ¶æ„è®¾è®¡ã€å®ç°ç»†èŠ‚å’Œæ‰©å±•æŒ‡å—ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

é¡¹ç›®é‡‡ç”¨ Clean Architecture + MVVM åˆ†å±‚æ¶æ„ï¼Œå®ç°é«˜å†…èšä½è€¦åˆçš„ä»£ç ç»„ç»‡ï¼š

- **UI å±‚**ï¼šåŸºäº Compose DSL æ„å»ºå£°æ˜å¼ UIï¼Œé€šè¿‡å•å‘æ•°æ®æµä¿è¯ UI ä¸€è‡´æ€§
- **ä¸šåŠ¡å±‚**ï¼šViewModel ä½œä¸º SSOTï¼Œç®¡ç† UI çŠ¶æ€å’Œä¸šåŠ¡é€»è¾‘ï¼Œé¿å…ç»„ä»¶é—´ç›´æ¥ä¾èµ–
- **æ•°æ®å±‚**ï¼šRepository Pattern å°è£…æ•°æ®æºè®¿é—®ç»†èŠ‚ï¼ŒDataStore å®ç°æŒä¹…åŒ–å­˜å‚¨
- **åŸºç¡€è®¾æ–½å±‚**ï¼šåŸºäº Coroutine + Flow çš„å¼‚æ­¥æ¡†æ¶ï¼Œç¡®ä¿ä¸»çº¿ç¨‹é›¶é˜»å¡

### æ ¸å¿ƒç»„ä»¶

1. **åº”ç”¨åŸºç¡€æ¶æ„**
   - `OperitApplication`: DI å®¹å™¨å’Œå…¨å±€ä¸Šä¸‹æ–‡ç®¡ç†
   - `MainActivity`: å…¥å£ç‚¹å’Œç”Ÿå‘½å‘¨æœŸæ§åˆ¶å™¨

2. **AI å¼•æ“æ¨¡å—**
   - `AIService`: AI åº•å±‚é€šä¿¡æŠ½è±¡å±‚ï¼Œæ”¯æŒå¤šç§æ¨¡å‹å¹³æ»‘åˆ‡æ¢
   - `EnhancedAIService`: å·¥å…·è°ƒç”¨å¢å¼ºç‰ˆæœåŠ¡ï¼Œå®ç° LLM-Agent èŒƒå¼

3. **å·¥å…·ç³»ç»Ÿæ¡†æ¶**
   - `AIToolHandler`: å·¥å…·è§£æå’Œæ‰§è¡Œå¼•æ“ï¼Œä½¿ç”¨å·¥å‚æ¨¡å¼æ³¨å†Œå·¥å…·å®ç°
   - å¤šç§å·¥å…·å®ç°ç±»ï¼ˆåŸºäºç­–ç•¥æ¨¡å¼çš„æ’ä»¶åŒ–æ¶æ„ï¼‰

4. **æƒé™ç®¡ç†ç³»ç»Ÿ**
   - `ToolPermissionManager`: ç»†ç²’åº¦æƒé™æ§åˆ¶å™¨ï¼Œæ”¯æŒè¿è¡Œæ—¶æƒé™ç®¡ç†
   - `PermissionRequestOverlay`: æƒé™å¼¹çª— UI ç»„ä»¶ï¼Œæ”¯æŒå¤šç§å±•ç¤ºç­–ç•¥

5. **UI ç»„ä»¶ä½“ç³»**
   - `OperitApp`: åº”ç”¨çº§ Composable å®¹å™¨ï¼Œç®¡ç†å…¨å±€å¯¼èˆª
   - åŠŸèƒ½æ¨¡å—åŒ– UI ç»„ä»¶ï¼ŒåŸºäº Slot API å®ç°é«˜åº¦å¯ç»„åˆæ€§

6. **ç³»ç»Ÿé›†æˆæ¨¡å—**
   - `AdbCommandExecutor`: åŸºäº Shizuku çš„ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œå™¨ï¼Œå®ç° ADB èƒ½åŠ›ä¸‹æ”¾
   - `UIAccessibilityService`: A11y æœåŠ¡å®ç°ï¼Œæä¾› UI è‡ªåŠ¨åŒ–åŸºç¡€èƒ½åŠ›
   - `FloatingChatService`: å…¨å±€æ‚¬æµ®çª—æœåŠ¡ï¼Œæ”¯æŒå¤šåœºæ™¯ AI äº¤äº’

## ğŸ’» æŠ€æœ¯æ ˆè¯¦è§£

- **Kotlin + KTX**ï¼šåˆ©ç”¨è¯­è¨€ç‰¹æ€§ç®€åŒ–ä»£ç ï¼Œå‡å°‘æ¨¡æ¿ä»£ç 
- **Jetpack Compose**ï¼šåŸºäº Kotlin åç¨‹çš„å£°æ˜å¼ UI æ¡†æ¶
- **åç¨‹ + Flow**ï¼šå“åº”å¼ç¼–ç¨‹èŒƒå¼ï¼Œè§£å†³å›è°ƒåœ°ç‹±
- **Shizuku Bridge**ï¼šç”¨äºè·å–ç‰¹æƒ API è®¿é—®æƒé™
- **A11y Framework**ï¼šå®ç°è·¨åº”ç”¨ UI äº¤äº’è‡ªåŠ¨åŒ–
- **Retrofit + OkHttp**ï¼šRESTful API å®¢æˆ·ç«¯ï¼Œå¤„ç†ç½‘ç»œé€šä¿¡

## ğŸ› ï¸ å·¥å…·ç³»ç»Ÿæ¶æ„

Operit çš„æ ¸å¿ƒç«äº‰åŠ›åœ¨äºå…¶çµæ´»çš„å·¥å…·ç³»ç»Ÿï¼Œé‡‡ç”¨æ’ä»¶åŒ–æ¶æ„ï¼Œæ”¯æŒåŠ¨æ€æ‰©å±•ï¼š

### å·¥å…·åˆ†ç±»ä½“ç³»

1. **ç³»ç»Ÿæ“ä½œå·¥å…·é›†**
   - ç³»ç»Ÿè®¾ç½®ç®¡ç† API
   - åº”ç”¨ç”Ÿå‘½å‘¨æœŸæ§åˆ¶æ¥å£
   - åº•å±‚ç³»ç»Ÿé…ç½®è®¿é—®å±‚

2. **UI è‡ªåŠ¨åŒ–å·¥å…·é›†**
   - UI æ ‘ä¿¡æ¯æå–å™¨
   - ç”¨æˆ·äº¤äº’æ¨¡æ‹Ÿå¼•æ“
   - å…ƒç´ å®šä½ä¸æ“ä½œæ§åˆ¶å™¨

3. **æ–‡ä»¶ç³»ç»Ÿå·¥å…·é›†**
   - æ–‡ä»¶ CRUD æ“ä½œå°è£…
   - ç›®å½•æ ‘éå†ä¸ç®¡ç†
   - å‹ç¼©/è§£å‹ç¼©å®ç”¨å·¥å…·

4. **ç½‘ç»œé€šä¿¡å·¥å…·é›†**
   - Web å†…å®¹è·å–å™¨
   - HTTP è¯·æ±‚åˆ†å‘å™¨
   - æœç´¢å¼•æ“æ¥å£é€‚é…å™¨

5. **åŸºç¡€å·¥å…·é›†**
   - è¡¨è¾¾å¼è®¡ç®—å¼•æ“
   - è®¾å¤‡ä¿¡æ¯æ”¶é›†å™¨
   - è°ƒè¯•ä¸æ¼”ç¤ºå·¥å…·

### å·¥å…·æ‰§è¡Œæµæ°´çº¿

1. AI ç”Ÿæˆç»“æ„åŒ–å·¥å…·è°ƒç”¨ï¼ˆXML æ ¼å¼ï¼‰
2. `AIToolHandler` è¿›è¡Œè¯æ³•åˆ†æå’Œè¯­æ³•è§£æ
3. `ToolPermissionManager` æ‰§è¡Œæƒé™æ£€æŸ¥ï¼ˆåŸºäº RBAC æ¨¡å‹ï¼‰
4. å·¥å…·æ‰§è¡Œå™¨æ ¹æ®ç­–ç•¥æ¨¡å¼åˆ†å‘åˆ°å…·ä½“å®ç°
5. ç»“æœå°è£…å¹¶è¿”å›ç»™ AI è¿›è¡Œä¸‹ä¸€æ­¥å†³ç­–

## ğŸ” æƒé™ç³»ç»Ÿè®¾è®¡

åº”ç”¨å®ç°äº†ä¸€å¥—åŸºäº RBAC çš„ç»†ç²’åº¦æƒé™æ§åˆ¶ç³»ç»Ÿï¼š

### æƒé™çº§åˆ«å®šä¹‰

- **ALLOW**ï¼šé™é»˜æ‰§è¡Œï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„
- **CAUTION**ï¼šå¯¹æ•æ„Ÿæ“ä½œè¿›è¡Œé£é™©è¯„ä¼°åè¯¢é—®
- **ASK**ï¼šå§‹ç»ˆè¦æ±‚ç”¨æˆ·ç¡®è®¤
- **FORBID**ï¼šç¦æ­¢æ‰§è¡Œï¼Œç›´æ¥æ‹’ç»è¯·æ±‚

### æƒé™åˆ†ç±»çŸ©é˜µ

æ¯ä¸ªå·¥å…·ç±»åˆ«ç»´æŠ¤ç‹¬ç«‹çš„æƒé™ç­–ç•¥ï¼š

- ç³»ç»Ÿæ“ä½œæƒé™åŸŸï¼ˆé«˜é£é™©ï¼‰
- ç½‘ç»œé€šä¿¡æƒé™åŸŸï¼ˆä¸­é£é™©ï¼‰
- UI è‡ªåŠ¨åŒ–æƒé™åŸŸï¼ˆé«˜é£é™©ï¼‰
- æ–‡ä»¶è¯»å–æƒé™åŸŸï¼ˆä¸­ä½é£é™©ï¼‰
- æ–‡ä»¶å†™å…¥æƒé™åŸŸï¼ˆä¸­é«˜é£é™©ï¼‰

### æƒé™æ§åˆ¶æµç¨‹

1. å·¥å…·è°ƒç”¨è§¦å‘æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥å…¨å±€ä¸»å¼€å…³çŠ¶æ€
2. æ ¹æ®å·¥å…·ç±»åˆ«æŸ¥è¯¢å¯¹åº”æƒé™åŸŸé…ç½®
3. CAUTION çº§åˆ«ä¸‹ï¼Œè°ƒç”¨å±é™©æ“ä½œæ£€æµ‹å™¨è¿›è¡Œè¯„ä¼°
4. éœ€è¦ç”¨æˆ·ç¡®è®¤æ—¶ï¼Œé€šè¿‡æ‚¬æµ®çª—æ˜¾ç¤ºæƒé™è¯·æ±‚
5. ç”¨æˆ·å†³ç­–ç»“æœé€šè¿‡å›è°ƒä¼ é€’ç»™è°ƒç”¨æ–¹

## ğŸ”„ é«˜çº§ç‰¹æ€§å®ç°

### å…¨å±€æ‚¬æµ®çª—

`FloatingChatService` å®ç°äº†ä¸€ä¸ªç³»ç»Ÿçº§çš„æµ®åŠ¨äº¤äº’ç•Œé¢ï¼š

- åŸºäº WindowManager çš„è§†å›¾æ³¨å…¥
- è‡ªå®šä¹‰æ‹–æ‹½ä¸ä½ç½®æŒä¹…åŒ–
- å‰å°æœåŠ¡ä¿æ´»æœºåˆ¶
- çŠ¶æ€ç®¡ç†ä¸ UI åˆ·æ–°ç­–ç•¥

### Shizuku é›†æˆ

åº”ç”¨ä¸ Shizuku ç‰¹æƒæœåŠ¡æ·±åº¦é›†æˆï¼š

- `ShizukuInstaller`ï¼šå†…ç½®å®‰è£…å™¨ï¼Œæ”¯æŒä¸€é”®éƒ¨ç½²
- `AdbCommandExecutor`ï¼šå‘½ä»¤æ‰§è¡Œå°è£…ï¼Œæ”¯æŒåŒæ­¥å’Œå¼‚æ­¥æ¨¡å¼
- åŸºäº Binder IPC çš„æƒé™è¯·æ±‚ä¸çŠ¶æ€ç›‘æ§

### æ— éšœç¢æœåŠ¡

`UIAccessibilityService` æä¾›äº†å¼ºå¤§çš„ UI è‡ªåŠ¨åŒ–èƒ½åŠ›ï¼š

- äº‹ä»¶ç›‘å¬ä¸ UI æ ‘è§£æ
- å…ƒç´ æŸ¥æ‰¾ä¸å®šä½ç®—æ³•
- åŠ¨ä½œæ¨¡æ‹Ÿä¸åé¦ˆå¤„ç†
- è·¨åº”ç”¨æ“ä½œåè®®

## ğŸ§ª å¼€å‘æŒ‡å—

### æ·»åŠ æ–°å·¥å…·

1. å®ç° `ToolExecutor` æ¥å£ï¼Œå°è£…å…·ä½“åŠŸèƒ½é€»è¾‘
2. åœ¨ `AIToolHandler` ä¸­æ³¨å†Œå·¥å…·ï¼Œåˆ†é…å”¯ä¸€æ ‡è¯†ç¬¦
3. åœ¨ `ToolCategoryMapper` ä¸­è®¾ç½®é€‚å½“çš„æƒé™ç±»åˆ«
4. æ›´æ–° `EnhancedAIService` ä¸­çš„ç³»ç»Ÿæç¤ºè¯ï¼Œä½¿ AI æ„ŸçŸ¥æ–°å·¥å…·

### æƒé™ç®¡ç†æœ€ä½³å®è·µ

æ–°å¢æ•æ„ŸåŠŸèƒ½æ—¶ï¼š

1. è¿›è¡Œé£é™©è¯„ä¼°ï¼Œé€‰æ‹©åˆé€‚çš„æƒé™åŸŸ
2. å¯¹é«˜é£é™©æ“ä½œé»˜è®¤è®¾ç½®ä¸º CAUTION æˆ– ASK
3. æä¾›æ¸…æ™°çš„æ“ä½œè¯´æ˜ï¼Œå¸®åŠ©ç”¨æˆ·åšå‡ºå†³ç­–
4. å®ç°é™çº§ç­–ç•¥ï¼Œå¤„ç†æƒé™è¢«æ‹’ç»çš„æƒ…å†µ

### UI è‡ªåŠ¨åŒ–å¼€å‘è§„èŒƒ

å®ç° UI è‡ªåŠ¨åŒ–å·¥å…·æ—¶ï¼š

1. å®ç°å¥å£®çš„é”™è¯¯å¤„ç†å’Œè¶…æ—¶æœºåˆ¶
2. æä¾›è¯¦ç»†çš„æ“ä½œåé¦ˆå’ŒçŠ¶æ€æ—¥å¿—
3. å°Šé‡ç³»ç»Ÿé™åˆ¶å’Œå®‰å…¨è¾¹ç•Œ
4. ä¼˜å…ˆä½¿ç”¨ combined_operation å·¥å…·æå‡ç”¨æˆ·ä½“éªŒ

## ğŸ“š API æ–‡æ¡£

### AIToolHandler

å·¥å…·ç®¡ç†æ ¸å¿ƒç±»ï¼š

```kotlin
// æ³¨å†Œå·¥å…·å®ç°
fun registerTool(name: String, executor: ToolExecutor)

// è§£æå¹¶æ‰§è¡Œå·¥å…·è°ƒç”¨
suspend fun extractAndExecuteTool(message: String): ToolExecutionResult

// æ‰§è¡Œå·²è§£æçš„å·¥å…·
suspend fun executeTool(tool: AITool): ToolResult
```

### ToolPermissionManager

æƒé™ç®¡ç†æ ¸å¿ƒç±»ï¼š

```kotlin
// æ£€æŸ¥å·¥å…·æ‰§è¡Œæƒé™
suspend fun checkToolPermission(tool: AITool): Boolean

// è¯·æ±‚ç”¨æˆ·æˆæƒ
private suspend fun requestPermission(tool: AITool): Boolean

// å¤„ç†æƒé™ç»“æœå›è°ƒ
fun handlePermissionResult(result: PermissionRequestResult)
```

### EnhancedAIService

AI æœåŠ¡æ ¸å¿ƒç±»ï¼š

```kotlin
// å‘é€ç”¨æˆ·æ¶ˆæ¯
fun sendMessage(message: String, callback: (String) -> Unit)

// å–æ¶ˆæµå¼ç”Ÿæˆ
fun cancelStreaming()

// å¤„ç†å·¥å…·æ‰§è¡Œç»“æœ
suspend fun processToolResult(toolResult: ToolResult)
```

## ğŸ”§ æ„å»ºä¸éƒ¨ç½²

### æ„å»ºé…ç½®

é¡¹ç›®ä½¿ç”¨ Gradle KTS ç®¡ç†æ„å»ºé…ç½®ï¼š

- minSdk = 26 (Android 8.0)
- targetSdk = 33 (Android 13)
- compileSdk = 34
- Compose Compiler ä¸ Kotlin ç‰ˆæœ¬å…¼å®¹æ€§é…ç½®

### ç­¾åé…ç½®

å‘å¸ƒæ„å»ºéœ€é…ç½®ç­¾åå¯†é’¥ï¼š

```kotlin
// åœ¨ keystore.properties ä¸­é…ç½®ï¼ˆä¸åŒ…å«åœ¨ä»£ç åº“ï¼‰
signingConfigs {
    create("release") {
        keyAlias = keystoreProperties["keyAlias"] as String
        keyPassword = keystoreProperties["keyPassword"] as String
        storeFile = file(keystoreProperties["storeFile"] as String)
        storePassword = keystoreProperties["storePassword"] as String
    }
}
```

### æ ¸å¿ƒä¾èµ–

å…³é”®ä¾èµ–é¡¹åŒ…æ‹¬ï¼š

- Jetpack Compose UI ç»„ä»¶åº“
- Shizuku API å®¢æˆ·ç«¯
- Kotlin åç¨‹ä¸ Flow
- OkHttp3 ä¸ Retrofit2
- å„ç§ AndroidX æ”¯æŒåº“

## ğŸ è°ƒè¯•æŠ€å·§

1. å¯ç”¨å¼€å‘è€…é€‰é¡¹ä¸­çš„è¯¦ç»†æ—¥å¿—è®°å½•
2. ä½¿ç”¨ `adb logcat -s AIToolHandler:D EnhancedAIService:D` ç­›é€‰ç›¸å…³æ—¥å¿—
3. å·¥å…·å¤±è´¥æ—¶æ£€æŸ¥æƒé™çŠ¶æ€å’Œç³»ç»Ÿé™åˆ¶
4. ç›‘æ§ Shizuku è¿æ¥çŠ¶æ€å’Œ Binder é€šä¿¡
5. ä½¿ç”¨ Compose é¢„è§ˆåŠŸèƒ½åŠ é€Ÿ UI å¼€å‘

## ğŸ“ æœªæ¥è§„åˆ’

1. å®ç°ç¦»çº¿ AI æ¨¡å‹é›†æˆï¼Œé™ä½ç½‘ç»œä¾èµ–
2. æ·»åŠ å¤šç”¨æˆ·æ”¯æŒï¼Œå®ç°è´¦æˆ·éš”ç¦»
3. æ‰©å±•å·¥å…·é›†ï¼Œå¢åŠ æ›´å¤šç³»ç»Ÿé›†æˆèƒ½åŠ›
4. ä¼˜åŒ–é”™è¯¯å¤„ç†å’Œè‡ªåŠ¨æ¢å¤æœºåˆ¶
5. å¢å¼º UI å®šåˆ¶åŒ–é€‰é¡¹å’Œä¸»é¢˜æ”¯æŒ
6. å®ç°ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„æ™ºèƒ½æ¨èç³»ç»Ÿ 